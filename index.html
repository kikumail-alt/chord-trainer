<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chord Trainer</title>
  <style>
    body { font-family: system-ui, sans-serif; padding: 24px; }
    h1 { margin: 0 0 14px; }
    .chord { font-size: 72px; font-weight: 800; margin: 16px 0 10px; }
    .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    button { padding: 10px 14px; font-size: 16px; cursor: pointer; }
    input[type="range"] { width: 220px; }

    .panel { margin-top: 18px; padding: 14px; border: 1px solid #ddd; border-radius: 12px; }
    .panel h2 { font-size: 16px; margin: 0 0 10px; }
    .checks { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px 12px; }
    .checks label { display: flex; gap: 8px; align-items: center; user-select: none; }
    .hint { font-size: 13px; color: #555; margin-top: 10px; }
    .warn { color: #b00020; font-size: 14px; margin-top: 8px; display:none; }

    .groupHeader { display: flex; align-items: center; gap: 10px; margin: 14px 0 6px; }
    .groupHeader h3 { margin: 0; min-width: 24px; }
    .smallBtn { padding: 6px 10px; font-size: 14px; }
  </style>
</head>
<body>
  <h1>Chord Trainer</h1>

  <div class="row">
    <label>表示秒数: <span id="secLabel">3</span> 秒</label>
    <input id="sec" type="range" min="1" max="10" value="3" />
  </div>

  <div class="chord" id="chord">C</div>

  <div class="row">
    <button id="start">Start</button>
    <button id="stop" disabled>Stop</button>
    <button id="next">Next</button>
    <label><input type="checkbox" id="random" checked> ランダム</label>
  </div>

  <div class="panel">
    <h2>表示するコードを選ぶ（ルートごと一括ON/OFF）</h2>

    <div class="row" style="margin-bottom:10px;">
      <button id="selectAll" type="button">全選択</button>
      <button id="clearAll" type="button">全解除</button>
    </div>

    <div id="checks"></div>
    <div class="warn" id="warn">⚠️ 1つ以上コードを選んでください</div>
    <div class="hint">※チェックしたコードだけが出題されます（選択は保存されます）</div>
  </div>

  <script>
    // ===== ルート別コード定義（ここを好みに増やしてOK） =====
    const CHORD_GROUPS = {
      "C": ["C", "Cm", "C7"],
      "D": ["D", "Dm", "D7"],
      "E": ["E", "Em", "E7"],
      "F": ["F", "Fm", "F7"],
      "G": ["G", "Gm", "G7"],
      "A": ["A", "Am", "A7"],
      "B": ["B", "Bm"]
    };

    const ALL_CHORDS = Object.values(CHORD_GROUPS).flat();

    // ===== 状態 =====
    let index = 0;
    let timerId = null;
    let intervalSec = 3;

    // ===== DOM =====
    const chordEl = document.getElementById("chord");
    const secEl = document.getElementById("sec");
    const secLabel = document.getElementById("secLabel");
    const startBtn = document.getElementById("start");
    const stopBtn = document.getElementById("stop");
    const nextBtn = document.getElementById("next");
    const randomEl = document.getElementById("random");

    const checksWrap = document.getElementById("checks");
    const warnEl = document.getElementById("warn");
    const selectAllBtn = document.getElementById("selectAll");
    const clearAllBtn = document.getElementById("clearAll");

    // ===== 選択状態（localStorage） =====
    const STORAGE_KEY = "chord_trainer_selected";

    function loadSelectedSet() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return new Set(ALL_CHORDS); // 初回は全選択
        const arr = JSON.parse(raw);
        if (!Array.isArray(arr) || arr.length === 0) return new Set(ALL_CHORDS);
        return new Set(arr.filter(c => ALL_CHORDS.includes(c)));
      } catch {
        return new Set(ALL_CHORDS);
      }
    }

    let selected = loadSelectedSet();

    function saveSelectedSet() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify([...selected]));
    }

    function getActiveChords() {
      return ALL_CHORDS.filter(c => selected.has(c));
    }

    function showWarn(show) {
      warnEl.style.display = show ? "block" : "none";
    }

    function showChord() {
      const chords = getActiveChords();
      if (chords.length === 0) {
        chordEl.textContent = "—";
        showWarn(true);
        return;
      }
      showWarn(false);
      chordEl.textContent = chords[index] ?? chords[0];
    }

    function nextChord() {
      const chords = getActiveChords();
      if (chords.length === 0) {
        stop();
        showChord();
        return;
      }

      if (randomEl.checked) {
        let next;
        do { next = Math.floor(Math.random() * chords.length); }
        while (next === index && chords.length > 1);
        index = next;
      } else {
        index = (index + 1) % chords.length;
      }

      showChord();
    }

    function start() {
      const chords = getActiveChords();
      if (chords.length === 0) {
        showChord();
        return;
      }
      if (timerId) return;
      timerId = setInterval(nextChord, intervalSec * 1000);
      startBtn.disabled = true;
      stopBtn.disabled = false;
    }

    function stop() {
      if (!timerId) return;
      clearInterval(timerId);
      timerId = null;
      startBtn.disabled = false;
      stopBtn.disabled = true;
    }

    // 表示秒数変更（動作中なら張り替え）
    secEl.addEventListener("input", () => {
      intervalSec = Number(secEl.value);
      secLabel.textContent = intervalSec;
      if (timerId) { stop(); start(); }
    });

    startBtn.addEventListener("click", start);
    stopBtn.addEventListener("click", stop);
    nextBtn.addEventListener("click", nextChord);

    // ===== チェックボックス描画（ルート別 + 一括ON/OFF） =====
    function applySelectionChange() {
      saveSelectedSet();
      index = 0;
      showChord();
      if (timerId && getActiveChords().length === 0) stop();
    }

    function renderChecks() {
      checksWrap.innerHTML = "";

      for (const root in CHORD_GROUPS) {
        const chordsInGroup = CHORD_GROUPS[root];

        // 見出し + 一括ON/OFF
        const header = document.createElement("div");
        header.className = "groupHeader";

        const title = document.createElement("h3");
        title.textContent = root;

        const onBtn = document.createElement("button");
        onBtn.type = "button";
        onBtn.className = "smallBtn";
        onBtn.textContent = `${root} 全ON`;

        const offBtn = document.createElement("button");
        offBtn.type = "button";
        offBtn.className = "smallBtn";
        offBtn.textContent = `${root} 全OFF`;

        header.appendChild(title);
        header.appendChild(onBtn);
        header.appendChild(offBtn);
        checksWrap.appendChild(header);

        // グループ内チェック
        const groupDiv = document.createElement("div");
        groupDiv.className = "checks";

        const inputs = [];

        onBtn.addEventListener("click", () => {
          for (const c of chordsInGroup) selected.add(c);
          for (const inp of inputs) inp.checked = true;
          applySelectionChange();
        });

        offBtn.addEventListener("click", () => {
          for (const c of chordsInGroup) selected.delete(c);
          for (const inp of inputs) inp.checked = false;
          applySelectionChange();
        });

        for (const c of chordsInGroup) {
          const label = document.createElement("label");
          const input = document.createElement("input");
          input.type = "checkbox";
          input.checked = selected.has(c);

          input.addEventListener("change", () => {
            if (input.checked) selected.add(c);
            else selected.delete(c);
            applySelectionChange();
          });

          inputs.push(input);

          const span = document.createElement("span");
          span.textContent = c;

          label.appendChild(input);
          label.appendChild(span);
          groupDiv.appendChild(label);
        }

        checksWrap.appendChild(groupDiv);
      }

      showChord();
    }

    // 全選択 / 全解除
    selectAllBtn.addEventListener("click", () => {
      selected = new Set(ALL_CHORDS);
      applySelectionChange();
      renderChecks();
    });

    clearAllBtn.addEventListener("click", () => {
      selected = new Set();
      applySelectionChange();
      renderChecks();
      stop();
    });

    // 初期表示
    renderChecks();
  </script>
</body>
</html>
